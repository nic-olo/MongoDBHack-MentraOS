name: China Cloud Deploy Marketing Website

on:
  push:
    branches:
      - dev
      - ya/modify-china-website
    paths:
      - "marketing/china/**"
      - ".github/workflows/china-deploy-marketing-website.yml"

jobs:
  china-cloud-deploy-marketing-website:
    name: Build & Deploy to Alibaba Cloud
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      MARKETING_OSS_BUCKET: mentra-dev-static-marketing
      MARKETING_OSS_CNAME: mentraglass.cn
      MARKETING_OSS_PATH: marketing/china/

    steps:
      # 1. Checkout source code
      - uses: actions/checkout@v4

      # 2. Install ossutil
      - name: Install ossutil
        run: |
          wget -O ossutil64 http://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      # 3. Configure ossutil with CNAME support
      - name: Configure ossutil
        run: |
          cat > /tmp/ossutilconfig <<EOF
          [Credentials]
          language=EN
          endpoint=oss-cn-shenzhen.aliyuncs.com
          accessKeyID=${{ secrets.ALIBABA_ACCESS_KEY_ID }}
          accessKeySecret=${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}

          [Bucket-Cname]
          ${MARKETING_OSS_BUCKET}=${MARKETING_OSS_CNAME}
          EOF
          echo "âœ… Created ossutil config with CNAME mapping"

      # 4. Upload marketing static files to OSS using the CNAME domain
      - name: Upload marketing static files to OSS
        run: |
          echo "ðŸš€ Uploading ${MARKETING_OSS_PATH}/ to oss://${MARKETING_OSS_BUCKET}/ via CNAME: ${MARKETING_OSS_CNAME}"
          ossutil -c /tmp/ossutilconfig sync ${MARKETING_OSS_PATH}/ oss://${MARKETING_OSS_BUCKET}/ \
            --delete \
            --force \
            --update

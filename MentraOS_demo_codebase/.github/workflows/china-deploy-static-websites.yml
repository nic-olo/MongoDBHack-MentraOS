name: China Cloud Deploy Static Websites

on:
  push:
    branches:
      - dev
    paths:
      - "cloud/websites/**"
      - ".github/workflows/china-deploy-static-websites.yml"

jobs:
  china-cloud-deploy-static-websites:
    name: Build & Deploy to Alibaba Cloud
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NODE_ENV: production
      STORE_OSS_BUCKET: mentra-dev-static-store
      STORE_OSS_CNAME: store.mentraglass.cn
      STORE_OSS_PATH: cloud/websites/store/dist
      ACCOUNT_OSS_BUCKET: mentra-dev-static-account
      ACCOUNT_OSS_CNAME: account.mentraglass.cn
      ACCOUNT_OSS_PATH: cloud/websites/account/dist
      CONSOLE_OSS_BUCKET: mentra-dev-static-console
      CONSOLE_OSS_CNAME: console.mentraglass.cn
      CONSOLE_OSS_PATH: cloud/websites/console/dist

    steps:
      # 1. Checkout source code
      - uses: actions/checkout@v4

      # 2. Setup Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 3. Install dependencies
      - name: Install dependencies
        working-directory: cloud
        run: bun install --frozen-lockfile

      # 4. Install ossutil
      - name: Install ossutil
        run: |
          wget -O ossutil64 http://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      # 5. Configure ossutil with CNAME support
      - name: Configure ossutil
        run: |
          cat > /tmp/ossutilconfig <<EOF
          [Credentials]
          language=EN
          endpoint=oss-cn-shenzhen.aliyuncs.com
          accessKeyID=${{ secrets.ALIBABA_ACCESS_KEY_ID }}
          accessKeySecret=${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}

          [Bucket-Cname]
          ${STORE_OSS_BUCKET}=${STORE_OSS_CNAME}
          ${ACCOUNT_OSS_BUCKET}=${ACCOUNT_OSS_CNAME}
          ${CONSOLE_OSS_BUCKET}=${CONSOLE_OSS_CNAME}
          EOF
          echo "âœ… Created ossutil config with CNAME mapping"

      # 6. Build store project
      - name: Build store project
        working-directory: cloud/websites/store
        env:
          VITE_CLOUD_API_URL: https://api.mentraglass.cn
          VITE_SUPABASE_URL: https://ykbiunzfbbtwlzdprmeh.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrYml1bnpmYmJ0d2x6ZHBybWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyODA2OTMsImV4cCI6MjA0OTg1NjY5M30.rbEsE8IRz-gb3-D0H8VAJtGw-xvipl1Nc-gCnnQ748U
          VITE_DEPLOYMENT_REGION: china
          VITE_AUTHING_APP_ID: 68ecd919227b7d8a6383721b
          VITE_AUTHING_APP_HOST: https://mentra.authing.cn
        run: bun run build

      # 7. Build account project
      - name: Build account project
        working-directory: cloud/websites/account
        env:
          VITE_CLOUD_API_URL: https://api.mentraglass.cn
          VITE_SUPABASE_URL: https://ykbiunzfbbtwlzdprmeh.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrYml1bnpmYmJ0d2x6ZHBybWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyODA2OTMsImV4cCI6MjA0OTg1NjY5M30.rbEsE8IRz-gb3-D0H8VAJtGw-xvipl1Nc-gCnnQ748U
          VITE_DEPLOYMENT_REGION: china
          VITE_AUTHING_APP_ID: 68ecd919227b7d8a6383721b
          VITE_AUTHING_APP_HOST: https://mentra.authing.cn
        run: bun run build

      # 8. Build console project
      - name: Build console project
        working-directory: cloud/websites/console
        env:
          VITE_API_URL: https://api.mentraglass.cn
          VITE_SUPABASE_URL: https://ykbiunzfbbtwlzdprmeh.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrYml1bnpmYmJ0d2x6ZHBybWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyODA2OTMsImV4cCI6MjA0OTg1NjY5M30.rbEsE8IRz-gb3-D0H8VAJtGw-xvipl1Nc-gCnnQ748U
          VITE_DEPLOYMENT_REGION: china
          VITE_AUTHING_APP_ID: 68ecd919227b7d8a6383721b
          VITE_AUTHING_APP_HOST: https://mentra.authing.cn
        run: bun run build

      # 9. Upload store static files to OSS using the CNAME domain
      - name: Upload store static files to OSS
        run: |
          echo "ðŸš€ Uploading ${STORE_OSS_PATH}/ to oss://${STORE_OSS_BUCKET}/ via CNAME: ${STORE_OSS_CNAME}"
          ossutil -c /tmp/ossutilconfig sync ${STORE_OSS_PATH}/ oss://${STORE_OSS_BUCKET}/ \
            --delete \
            --force \
            --update

      # 10. Upload account static files to OSS using the CNAME domain
      - name: Upload account static files to OSS
        run: |
          echo "ðŸš€ Uploading ${ACCOUNT_OSS_PATH}/ to oss://${ACCOUNT_OSS_BUCKET}/ via CNAME: ${ACCOUNT_OSS_CNAME}"
          ossutil -c /tmp/ossutilconfig sync ${ACCOUNT_OSS_PATH}/ oss://${ACCOUNT_OSS_BUCKET}/ \
            --delete \
            --force \
            --update

      # 11. Upload console static files to OSS using the CNAME domain
      - name: Upload console static files to OSS
        run: |
          echo "ðŸš€ Uploading ${CONSOLE_OSS_PATH}/ to oss://${CONSOLE_OSS_BUCKET}/ via CNAME: ${CONSOLE_OSS_CNAME}"
          ossutil -c /tmp/ossutilconfig sync ${CONSOLE_OSS_PATH}/ oss://${CONSOLE_OSS_BUCKET}/ \
            --delete \
            --force \
            --update

name: PR Checkout Helper

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  comment-checkout-instructions:
    runs-on: ubuntu-latest
    steps:
      - name: Comment PR with checkout instructions
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prBranch = pr.head.ref;
            const prRepo = pr.head.repo;

            // Check if PR is from a fork
            const isFork = pr.head.repo.full_name !== pr.base.repo.full_name;

            let checkoutInstructions = '';

            // Build checkout section based on fork status
            let checkoutSection = '';
            if (isFork && prRepo) {
              const forkOwner = pr.head.repo.owner.login;
              const forkRepo = pr.head.repo.name;
              const localBranchName = `${forkOwner}-${prBranch}`.replace(/[^a-zA-Z0-9-]/g, '-');

              checkoutSection = `\`\`\`bash\ngh pr checkout ${prNumber}\n\`\`\`\n<details>\n<summary>Alternative methods</summary>\n\n\`\`\`bash\ngit fetch https://github.com/${forkOwner}/${forkRepo}.git ${prBranch}:${localBranchName} && git checkout ${localBranchName}\n\`\`\`\n</details>`;
            } else {
              checkoutSection = `\`\`\`bash\ngh pr checkout ${prNumber}\n\`\`\``;
            }

            // Full comment with markers for build status updates
            checkoutInstructions = `<!-- pr-review-helper -->\n## üìã PR Review Helper\n\n<!-- android-build-status -->\n### üì± Android Build\n‚è≥ _Waiting for build..._\n<!-- /android-build-status -->\n\n---\n### üîÄ Test Locally\n${checkoutSection}`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: checkoutInstructions
            });
